(* ::Package:: *)

(************************************************************************)
(* This file was generated automatically by the Mathematica front end.  *)
(* It contains Initialization cells from a Notebook file, which         *)
(* typically will have the same name as this file except ending in      *)
(* ".nb" instead of ".m".                                               *)
(*                                                                      *)
(* This file is intended to be loaded into the Mathematica kernel using *)
(* the package loading commands Get or Needs.  Doing so is equivalent   *)
(* to using the Evaluate Initialization Cells menu command in the front *)
(* end.                                                                 *)
(*                                                                      *)
(* DO NOT EDIT THIS FILE.  This entire file is regenerated              *)
(* automatically each time the parent Notebook file is saved in the     *)
(* Mathematica front end.  Any changes you make to this file will be    *)
(* overwritten.                                                         *)
(************************************************************************)



(* ::Input::Initialization:: *)
hex2dec[str_]:=FromDigits[ToExpression[Characters[str]],16]


(* ::Input::Initialization:: *)
t$ascii  = hex2dec["0001"];
t$s32    = hex2dec["0002"];
t$dbl    = hex2dec["0003"];
t$undef  = hex2dec["0000"];
t$null	 = hex2dec["0010"];
t$u8	 = hex2dec["0020"];
t$s8	 = hex2dec["0030"];
t$u16	 = hex2dec["0040"];
t$s16	 = hex2dec["0050"];
t$u32	 = hex2dec["0060"];
t$u64	 = hex2dec["0070"];
t$s64	 = hex2dec["0080"];
t$flt	 = hex2dec["0090"];
(* Block types *)
t$dir    = hex2dec["0100"];
t$edir   = hex2dec["0200"];
t$sval   = hex2dec["0400"];
t$arr    = hex2dec["0800"];


(* ::Input::Initialization:: *)
BeginPackage["gdfBinaryInterpret`"];


(* ::Input::Initialization:: *)
gdfBinaryInterpret::usage="gdfBinaryInterpret[\"filename\"] interprets an GDF Binary-Formatted File";


(* ::Input::Initialization:: *)
Begin["`Private`"]


(* ::Input::Initialization:: *)
hex2dec[str_]:=FromDigits[ToExpression[Characters[str]],16]


(* ::Input::Initialization:: *)
t$ascii  = hex2dec["0001"];
t$s32    = hex2dec["0002"];
t$dbl    = hex2dec["0003"];
t$undef  = hex2dec["0000"];
t$null	 = hex2dec["0010"];
t$u8	 = hex2dec["0020"];
t$s8	 = hex2dec["0030"];
t$u16	 = hex2dec["0040"];
t$s16	 = hex2dec["0050"];
t$u32	 = hex2dec["0060"];
t$u64	 = hex2dec["0070"];
t$s64	 = hex2dec["0080"];
t$flt	 = hex2dec["0090"];
(* Block types *)
t$dir    = hex2dec["0100"];
t$edir   = hex2dec["0200"];
t$sval   = hex2dec["0400"];
t$arr    = hex2dec["0800"];


(* ::Input::Initialization:: *)
GDFID  = 94325877;


(* ::Input::Initialization:: *)
$replacementrules={"@"->"\[Sterling]","|"->"$"};


(* ::Input::Initialization:: *)
gdfBinaryInterpret[filein_, opts___] := Block[{verbose, ans, append, tmpans, tmpdata, tmparray,prepend,dotime,doposition,temporaryarrays=Association[],temporaryvalues=Association[]},
verbose = Global`gdfVerbose /. {opts} /. {Global`gdfVerbose -> False};
prepend = Global`gdfPrefix /. {opts} /. {Global`gdfPrefix -> ""};
append = Global`gdfPostfix /. {opts} /. {Global`gdfPostfix -> ""};
dotime=Global`gdfTime/. {opts} /. {Global`gdfTime ->True};
doposition=Global`gdfPosition/. {opts} /. {Global`gdfPosition ->True};
file = OpenRead[filein, BinaryFormat -> True];
                      
ID = BinaryRead[file, "UnsignedInteger32"];
If[ID === GDFID,
$GDFTimeCreated = BinaryRead[file, "UnsignedInteger32"];
ans = Table[BinaryRead[file, "UnsignedInteger8"], {16}];
$GDFCreator = FromCharacterCode[Take[ans, Position[ans, 0][[1, 1]] - 1]];
ans = Table[BinaryRead[file, "UnsignedInteger8"], {16}];
$GDFDestination = FromCharacterCode[Take[ans, Position[ans, 0][[1, 1]] - 1]];
major = BinaryRead[file, "UnsignedInteger8"];
minor = BinaryRead[file, "UnsignedInteger8"];
$GDFVersion = ToString[major] <> "." <> ToString[minor];
major = BinaryRead[file, "UnsignedInteger8"];
minor = BinaryRead[file, "UnsignedInteger8"];
$GDFCreatorVersion = ToString[major] <> "." <> ToString[minor];
major = BinaryRead[file, "UnsignedInteger8"];
minor = BinaryRead[file, "UnsignedInteger8"];
$GDFDestinationVersion = ToString[major] <> "." <> ToString[minor];
Table[BinaryRead[file, "UnsignedInteger8"], {2}];
columnnames = parameternames = {};
level = 1;
lastarr = False;
$name = Table[BinaryRead[file, "UnsignedInteger8"], {16}];
$time = AbsoluteTime[];
While[Not[MemberQ[$name, EndOfFile]],
positiondata=timedata=False;
$name = FromCharacterCode[Take[$name, Position[$name, 0][[1, 1]] - 1]];
$name = StringReplace[$name, $replacementrules];
(*Print[$name];*)
If[$name==="time",append="t";timedata=True,
If[$name==="position",append="p";positiondata=True]];
$name = StringJoin[prepend,$name, append];
$type = BinaryRead[file, "UnsignedInteger32"];
$size = BinaryRead[file, "UnsignedInteger32"];

isDir = BitAnd[$type, t$dir] > 0;
iseDir = BitAnd[$type, t$edir] > 0;
issVal = BitAnd[$type, t$sval] > 0;
isArray = BitAnd[$type, t$arr] > 0;
 datType = BitAnd[$type, 255];

If[issVal,
Switch[datType,
t$dbl, tmpans = BinaryRead[file, "Real64"];,
t$null, tmpans = Null;,
t$ascii, tmpdata = BinaryReadList[file, "UnsignedInteger8", $size];tmpans = FromCharacterCode[Take[tmpdata, Position[tmpdata, 0][[1, 1]] - 1]],
t$s32, tmpans = BinaryRead[file, "Integer32"],
_, If[$size > 0,
tmpdata = BinaryReadList[file, "UnsignedInteger8", $size];
tmpans = FromCharacterCode[Take[tmpdata, Position[tmpdata, 0][[1, 1]] - 1]]
]];

If[MemberQ[parameternames, $name],
AppendTo[temporaryvalues[$name],tmpans];
,
AppendTo[parameternames, $name];
AppendTo[temporaryvalues,$name->{tmpans}];
]
];

If[isArray&&$size>0,
tmpans = BinaryReadList[file, "Real64", $size/8];
If[MemberQ[columnnames, $name],
AppendTo[temporaryarrays[$name],tmpans];
,
AppendTo[columnnames, $name];
AppendTo[temporaryarrays,$name->{tmpans}];
];
];
lastarr = isArray;
$name = Table[BinaryRead[file, "UnsignedInteger8"], {16}]
];
(Clear[Evaluate[#]];
Evaluate[(Symbol@#)]=temporaryvalues[#])&/@Keys[temporaryvalues];
(Clear[Evaluate[#]];
Evaluate[(Symbol@#)]=temporaryarrays[#])&/@Keys[temporaryarrays];
If[verbose,
Print["Variables (Re)Assigned: " <> ToString[Union[columnnames]]];
Print["Parameters (Re)Assigned: " <> ToString[Union[parameternames]]]
];
Close[file];,
Print["Not a Binary GDF File!"];
]
]


(* ::Input::Initialization:: *)
gdfBinaryInterpret[filesin_List, opts___] := Block[{verbose, ans, append, tmpans, tmpdata, tmparray},
verbose = Global`gdfVerbose /. {opts} /. {Global`gdfVerbose -> False};
append = Global`gdfPostfix /. {opts} /. {Global`gdfPostfix -> ""};

columnnames = parameternames = {};

Block[{},
file = OpenRead[#, BinaryFormat -> True];
ID = BinaryRead[file, "UnsignedInteger32"];
If[ID === GDFID,
$GDFTimeCreated = BinaryRead[file, "UnsignedInteger32"];
ans = Table[BinaryRead[file, "UnsignedInteger8"], {16}];
$GDFCreator = FromCharacterCode[Take[ans, Position[ans, 0][[1, 1]] - 1]];
ans = Table[BinaryRead[file, "UnsignedInteger8"], {16}];
$GDFDestination = FromCharacterCode[Take[ans, Position[ans, 0][[1, 1]] - 1]];
major = BinaryRead[file, "UnsignedInteger8"];
minor = BinaryRead[file, "UnsignedInteger8"];
$GDFVersion = ToString[major] <> "." <> ToString[minor];
major = BinaryRead[file, "UnsignedInteger8"];
minor = BinaryRead[file, "UnsignedInteger8"];
$GDFCreatorVersion = ToString[major] <> "." <> ToString[minor];
major = BinaryRead[file, "UnsignedInteger8"];
minor = BinaryRead[file, "UnsignedInteger8"];
$GDFDestinationVersion = ToString[major] <> "." <> ToString[minor];
Table[BinaryRead[file, "UnsignedInteger8"], {2}];
level = 1;
lastarr = False;
$name = Table[BinaryRead[file, "UnsignedInteger8"], {16}];
(*Print[$name];*)
$time = AbsoluteTime[];
While[Not[MemberQ[$name, EndOfFile]], $name = FromCharacterCode[Take[$name, Position[$name, 0][[1, 1]] - 1]];     $name = StringReplace[$name, $replacementrules];
If[$name==="time",append="t",
If[$name==="position",append="p"]];
$name = StringJoin[$name, append];
$type = BinaryRead[file, "UnsignedInteger32"];
$size = BinaryRead[file, "UnsignedInteger32"];

isDir = BitAnd[$type, t$dir] > 0;
iseDir = BitAnd[$type, t$edir] > 0;
issVal = BitAnd[$type, t$sval] > 0;
isArray = BitAnd[$type, t$arr] > 0;
 datType = BitAnd[$type, 255];

If[issVal,Switch[datType,
t$dbl, tmpans = BinaryRead[file, "Real64"];,
t$null, tmpans = Null;,
t$ascii, tmpdata = BinaryReadList[file, "UnsignedInteger8", $size];tmpans = FromCharacterCode[Take[tmpdata, Position[tmpdata, 0][[1, 1]] - 1]],
t$s32, tmpans = BinaryRead[file, "Integer32"],
_, If[$size > 0,
tmpdata = BinaryReadList[file, "UnsignedInteger8", $size];
tmpans = FromCharacterCode[Take[tmpdata, Position[tmpdata, 0][[1, 1]] - 1]]
]];

If[MemberQ[parameternames, $name],
tmparr = Evaluate[Symbol@$name];
Clear[Evaluate[$name]];
Evaluate[(Symbol@$name)] = {Sequence @@ tmparr, tmpans};,
AppendTo[parameternames, $name];
Clear[Evaluate[$name]];
Evaluate[(Symbol@$name)] = {tmpans};
]
];

If[isArray,
tmpans = BinaryReadList[file, "Real64", $size/8];
If[MemberQ[columnnames, $name],
tmparr = Evaluate[Symbol@$name];
Clear[Evaluate[$name]];
Evaluate[(Symbol@$name)] = {Sequence @@ tmparr, tmpans};,
AppendTo[columnnames, $name];
Clear[Evaluate[$name]];
Evaluate[(Symbol@$name)] = {tmpans};
];
];
lastarr = isArray;
$name = Table[BinaryRead[file, "UnsignedInteger8"], {16}]
];
Close[file];,
Print["Not a Binary GDF File!"];
]]&/@filesin;
If[verbose,
Print["Variables (Re)Assigned: " <> ToString[Union[columnnames]]];
Print["Parameters (Re)Assigned: " <> ToString[Union[parameternames]]]
];
]


(* ::Input::Initialization:: *)
End[]


(* ::Input::Initialization:: *)
EndPackage[]
